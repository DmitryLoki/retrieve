// http://www.movable-type.co.uk/scripts/latlong.html
function LatLon(a,b,c){if(typeof c=="undefined")c=6371;this._lat=typeof a=="number"?a:typeof a=="string"&&a.trim()!=""?+a:NaN;this._lon=typeof b=="number"?b:typeof b=="string"&&b.trim()!=""?+b:NaN;this._radius=typeof c=="number"?c:typeof c=="string"&&trim(b)!=""?+c:NaN}LatLon.prototype.distanceTo=function(a,b){if(typeof b=="undefined")b=4;var c=this._radius;var d=this._lat.toRad(),e=this._lon.toRad();var f=a._lat.toRad(),g=a._lon.toRad();var h=f-d;var i=g-e;var j=Math.sin(h/2)*Math.sin(h/2)+Math.cos(d)*Math.cos(f)*Math.sin(i/2)*Math.sin(i/2);var k=2*Math.atan2(Math.sqrt(j),Math.sqrt(1-j));var l=c*k;return l.toPrecisionFixed(b)};LatLon.prototype.bearingTo=function(a){var b=this._lat.toRad(),c=a._lat.toRad();var d=(a._lon-this._lon).toRad();var e=Math.sin(d)*Math.cos(c);var f=Math.cos(b)*Math.sin(c)-Math.sin(b)*Math.cos(c)*Math.cos(d);var g=Math.atan2(e,f);return(g.toDeg()+360)%360};LatLon.prototype.finalBearingTo=function(a){var b=a._lat.toRad(),c=this._lat.toRad();var d=(this._lon-a._lon).toRad();var e=Math.sin(d)*Math.cos(c);var f=Math.cos(b)*Math.sin(c)-Math.sin(b)*Math.cos(c)*Math.cos(d);var g=Math.atan2(e,f);return(g.toDeg()+180)%360};LatLon.prototype.midpointTo=function(a){lat1=this._lat.toRad(),lon1=this._lon.toRad();lat2=a._lat.toRad();var b=(a._lon-this._lon).toRad();var c=Math.cos(lat2)*Math.cos(b);var d=Math.cos(lat2)*Math.sin(b);lat3=Math.atan2(Math.sin(lat1)+Math.sin(lat2),Math.sqrt((Math.cos(lat1)+c)*(Math.cos(lat1)+c)+d*d));lon3=lon1+Math.atan2(d,Math.cos(lat1)+c);lon3=(lon3+3*Math.PI)%(2*Math.PI)-Math.PI;return new LatLon(lat3.toDeg(),lon3.toDeg())};LatLon.prototype.destinationPoint=function(a,b){b=typeof b=="number"?b:typeof b=="string"&&b.trim()!=""?+b:NaN;b=b/this._radius;a=a.toRad();var c=this._lat.toRad(),d=this._lon.toRad();var e=Math.asin(Math.sin(c)*Math.cos(b)+Math.cos(c)*Math.sin(b)*Math.cos(a));var f=d+Math.atan2(Math.sin(a)*Math.sin(b)*Math.cos(c),Math.cos(b)-Math.sin(c)*Math.sin(e));f=(f+3*Math.PI)%(2*Math.PI)-Math.PI;return new LatLon(e.toDeg(),f.toDeg())};LatLon.intersection=function(a,b,c,d){b=typeof b=="number"?b:typeof b=="string"&&trim(b)!=""?+b:NaN;d=typeof d=="number"?d:typeof d=="string"&&trim(d)!=""?+d:NaN;lat1=a._lat.toRad(),lon1=a._lon.toRad();lat2=c._lat.toRad(),lon2=c._lon.toRad();brng13=b.toRad(),brng23=d.toRad();dLat=lat2-lat1,dLon=lon2-lon1;dist12=2*Math.asin(Math.sqrt(Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)*Math.sin(dLon/2)));if(dist12==0)return null;brngA=Math.acos((Math.sin(lat2)-Math.sin(lat1)*Math.cos(dist12))/(Math.sin(dist12)*Math.cos(lat1)));if(isNaN(brngA))brngA=0;brngB=Math.acos((Math.sin(lat1)-Math.sin(lat2)*Math.cos(dist12))/(Math.sin(dist12)*Math.cos(lat2)));if(Math.sin(lon2-lon1)>0){brng12=brngA;brng21=2*Math.PI-brngB}else{brng12=2*Math.PI-brngA;brng21=brngB}alpha1=(brng13-brng12+Math.PI)%(2*Math.PI)-Math.PI;alpha2=(brng21-brng23+Math.PI)%(2*Math.PI)-Math.PI;if(Math.sin(alpha1)==0&&Math.sin(alpha2)==0)return null;if(Math.sin(alpha1)*Math.sin(alpha2)<0)return null;alpha3=Math.acos(-Math.cos(alpha1)*Math.cos(alpha2)+Math.sin(alpha1)*Math.sin(alpha2)*Math.cos(dist12));dist13=Math.atan2(Math.sin(dist12)*Math.sin(alpha1)*Math.sin(alpha2),Math.cos(alpha2)+Math.cos(alpha1)*Math.cos(alpha3));lat3=Math.asin(Math.sin(lat1)*Math.cos(dist13)+Math.cos(lat1)*Math.sin(dist13)*Math.cos(brng13));dLon13=Math.atan2(Math.sin(brng13)*Math.sin(dist13)*Math.cos(lat1),Math.cos(dist13)-Math.sin(lat1)*Math.sin(lat3));lon3=lon1+dLon13;lon3=(lon3+3*Math.PI)%(2*Math.PI)-Math.PI;return new LatLon(lat3.toDeg(),lon3.toDeg())};LatLon.prototype.rhumbDistanceTo=function(a){var b=this._radius;var c=this._lat.toRad(),d=a._lat.toRad();var e=(a._lat-this._lat).toRad();var f=Math.abs(a._lon-this._lon).toRad();var g=Math.log(Math.tan(d/2+Math.PI/4)/Math.tan(c/2+Math.PI/4));var h=!isNaN(e/g)?e/g:Math.cos(c);if(Math.abs(f)>Math.PI){f=f>0?-(2*Math.PI-f):2*Math.PI+f}var i=Math.sqrt(e*e+h*h*f*f)*b;return i.toPrecisionFixed(4)};LatLon.prototype.rhumbBearingTo=function(a){var b=this._lat.toRad(),c=a._lat.toRad();var d=(a._lon-this._lon).toRad();var e=Math.log(Math.tan(c/2+Math.PI/4)/Math.tan(b/2+Math.PI/4));if(Math.abs(d)>Math.PI)d=d>0?-(2*Math.PI-d):2*Math.PI+d;var f=Math.atan2(d,e);return(f.toDeg()+360)%360};LatLon.prototype.rhumbDestinationPoint=function(a,b){var c=this._radius;var d=parseFloat(b)/c;var e=this._lat.toRad(),f=this._lon.toRad();a=a.toRad();var g=e+d*Math.cos(a);var h=g-e;var i=Math.log(Math.tan(g/2+Math.PI/4)/Math.tan(e/2+Math.PI/4));var j=!isNaN(h/i)?h/i:Math.cos(e);var k=d*Math.sin(a)/j;if(Math.abs(g)>Math.PI/2)g=g>0?Math.PI-g:-Math.PI-g;lon2=(f+k+3*Math.PI)%(2*Math.PI)-Math.PI;return new LatLon(g.toDeg(),lon2.toDeg())};LatLon.prototype.rhumbMidpointTo=function(a){lat1=this._lat.toRad(),lon1=this._lon.toRad();lat2=a._lat.toRad(),lon2=a._lon.toRad();var b=(lat1+lat2)/2;var c=Math.tan(Math.PI/4+lat1/2);var d=Math.tan(Math.PI/4+lat2/2);var e=Math.tan(Math.PI/4+b/2);var f=((lon2-lon1)*Math.log(e)+lon1*Math.log(d)-lon2*Math.log(c))/Math.log(d/c);if(isNaN(f))f=(lon1+lon2)/2;f=(f+3*Math.PI)%(2*Math.PI)-Math.PI;return new LatLon(b.toDeg(),f.toDeg())};LatLon.prototype.lat=function(a,b){if(typeof a=="undefined")return this._lat;return Geo.toLat(this._lat,a,b)};LatLon.prototype.lon=function(a,b){if(typeof a=="undefined")return this._lon;return Geo.toLon(this._lon,a,b)};LatLon.prototype.toString=function(a,b){if(typeof a=="undefined")a="dms";if(isNaN(this._lat)||isNaN(this._lon))return"-,-";return Geo.toLat(this._lat,a,b)+", "+Geo.toLon(this._lon,a,b)};if(typeof Number.prototype.toRad=="undefined"){Number.prototype.toRad=function(){return this*Math.PI/180}}if(typeof Number.prototype.toDeg=="undefined"){Number.prototype.toDeg=function(){return this*180/Math.PI}}if(typeof Number.prototype.toPrecisionFixed=="undefined"){Number.prototype.toPrecisionFixed=function(a){var b=this.toPrecision(a);b=b.replace(/(.+)e\+(.+)/,function(a,b,c){b=b.replace(/\./,"");l=b.length-1;while(c-->l)b=b+"0";return b});b=b.replace(/(.+)e-(.+)/,function(a,b,c){b=b.replace(/\./,"");while(c-->1)b="0"+b;return"0."+b});return b}}if(typeof String.prototype.trim=="undefined"){String.prototype.trim=function(){return String(this).replace(/^\s\s*/,"").replace(/\s\s*$/,"")}}